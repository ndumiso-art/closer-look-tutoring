<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Register | A Closer Look</title>
<style>
  :root{
    --card-bg: #fff;
    --page-bg: #f4f6f8;
    --accent: #f4d35e;
    --accent-dark: #ee6c4d;
    --muted: #6b7280;
    --success: #16a34a;
    --warn: #f59e0b;
    --danger: #ef4444;
    --pill-bg: #eef2ff;
  }

  body {
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: var(--page-bg);
    margin: 0;
    color: #111827;
  }

  header {
    background: #111827;
    color: #fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0.8rem 1rem;
  }
  header img{ height:44px; }
  header nav a{ color:#fff; margin-left:1rem; text-decoration:none; font-weight:600; font-size:0.95rem; }

  .container {
    max-width:920px;
    margin:1.5rem auto;
    padding:1rem;
  }

  .card{
    background:var(--card-bg);
    border-radius:14px;
    padding:1.25rem;
    box-shadow: 0 8px 30px rgba(2,6,23,0.08);
  }

  h1 { margin:0 0 0.25rem; font-size:1.5rem; }
  p.lead { margin:0 0 1rem; color:var(--muted); }

  .grid {
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:1rem;
  }

  /* Left column form */
  .form-col { padding-right:0.5rem; }
  label.input-label{ display:block; margin-top:0.75rem; font-weight:600; font-size:0.95rem; }
  input[type=text], input[type=tel], select {
    width:100%; padding:0.7rem; margin-top:0.35rem; border-radius:8px; border:1px solid #e5e7eb; font-size:0.95rem;
  }

  /* Days & slots grid */
  .days-grid {
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:0.6rem;
    margin-top:0.6rem;
  }
  .day-card {
    background:#fafafa;
    border-radius:10px;
    padding:0.6rem;
    border:1px solid #eee;
  }
  .day-title { font-weight:700; margin-bottom:0.5rem; }

  .slot-row {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:0.5rem;
    padding:0.25rem 0;
  }

  .slot-left { display:flex; align-items:center; gap:0.6rem; }
  .slot-left input[type=checkbox]{ width:18px; height:18px; transform:scale(1.05); }
  .slot-label { font-size:0.95rem; color:#111827; }

  .seat-pill {
    font-size:0.82rem;
    padding:0.28rem 0.6rem;
    border-radius:999px;
    min-width:68px;
    text-align:center;
    font-weight:600;
    color:#fff;
  }
  .pill-available { background:var(--success); }
  .pill-low { background:var(--warn); }
  .pill-full { background:var(--danger); }

  /* Right column summary */
  .summary {
    padding:0.6rem;
    border-left:1px dashed #e6e6e6;
  }
  .summary h3 { margin-top:0; font-size:1.05rem; }
  .summary .price { font-size:1.2rem; font-weight:800; margin:0.6rem 0; color:#111827; }
  .summary .note { color:var(--muted); font-size:0.9rem; }

  button.primary {
    display:block;
    width:100%;
    background:var(--accent);
    border:none;
    color:#111827;
    font-weight:800;
    padding:0.9rem;
    border-radius:10px;
    cursor:pointer;
    margin-top:0.8rem;
    font-size:1rem;
  }
  button.primary:hover{ background:var(--accent-dark); color:#fff; }

  .success { margin-top:0.8rem; padding:0.7rem; border-radius:8px; background:#ecfdf5; color:#065f46; font-weight:700; display:none; }

  @media(max-width:980px){
    .grid{ grid-template-columns:1fr; }
    .summary{ border-left:none; border-top:1px dashed #e6e6e6; margin-top:0.8rem; padding-top:0.8rem; }
    .days-grid{ grid-template-columns: repeat(2, 1fr); }
  }
  @media(max-width:520px){
    .days-grid{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img src="assets/logo.jpg" alt="logo">
    <div style="font-weight:800">A Closer Look</div>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <h1>Register — Back to School 2026</h1>
    <p class="lead">Mathematics & Physical Sciences | Grades 10–12 — 5–10 Jan 2026. Choose day(s) and slot(s).</p>

    <div class="grid">
      <!-- FORM -->
      <div class="form-col">
        <label class="input-label">First Name</label>
        <input id="name" type="text" placeholder="First name" required>

        <label class="input-label">Surname</label>
        <input id="surname" type="text" placeholder="Surname" required>

        <label class="input-label">Phone number</label>
        <input id="phone" type="tel" placeholder="e.g. 0821234567" required>

        <label class="input-label">Grade</label>
        <select id="grade">
          <option value="Grade 10">Grade 10</option>
          <option value="Grade 11">Grade 11</option>
          <option value="Grade 12">Grade 12</option>
        </select>

        <label class="input-label" style="margin-top:14px">Days & Slots</label>
        <div class="days-grid" id="daysGrid">
          <!-- JS will inject day cards here -->
        </div>
      </div>

      <!-- SUMMARY / ACTION -->
      <div class="summary">
        <h3>Booking Summary</h3>
        <div class="note">Select any combination. Each Day+Slot = 1 session.</div>
        <div class="price" id="totalPrice">R0</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="submitBtn" class="primary">Register Now</button>
        </div>
        <div class="success" id="successMsg"></div>
      </div>
    </div>
  </div>
</div>

<script>
/*
 Upgraded UI + logic:
 - day x slot grid with badges
 - live seat counts per day-slot (fetched from JSONBin)
 - disable full slots (cannot select)
 - total price updates
 - prevents overbooking on submit
 - uses X-Access-Key (placeholders below)
*/

const BIN_ID = "6958f052d0ea881f40516960";            // <-- set your bin id
const ACCESS_KEY = "$2a$10$G/2F8dg1rqmTSZlapmiYLOwmYhUxMNkjBXshkUUXdGKl3nmfgak5W";  // <-- set your X-Access-Key
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
const MAX_PER_SLOT = 25;
const PRICE_PER_SLOT = 150;

const days = ["Day 1","Day 2","Day 3","Day 4","Day 5","Day 6"];
const slots = ["09h00-13h30","14h00-18h00"];

const daysGrid = document.getElementById('daysGrid');
const totalPriceEl = document.getElementById('totalPrice');
const successMsgEl = document.getElementById('successMsg');
const submitBtn = document.getElementById('submitBtn');

let seatCounts = {}; // key: "Day 1|09h00-13h30" -> seats left (number)

// helper to sanitize id
function idFor(day, slot){
  return `seat-${day.replace(/\s+/g,'_')}-${slot.replace(/[^a-zA-Z0-9]/g,'_')}`;
}

// build UI grid
function buildGrid(){
  daysGrid.innerHTML = '';
  days.forEach(day => {
    const dayCard = document.createElement('div');
    dayCard.className = 'day-card';

    const title = document.createElement('div');
    title.className = 'day-title';
    title.innerText = day;
    dayCard.appendChild(title);

    slots.forEach(slot => {
      const row = document.createElement('div');
      row.className = 'slot-row';

      const left = document.createElement('div');
      left.className = 'slot-left';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.dataset.day = day;
      checkbox.dataset.slot = slot;
      checkbox.className = 'slot-checkbox';

      const label = document.createElement('div');
      label.className = 'slot-label';
      label.innerText = slot.replace('09h00-13h30','Morning').replace('14h00-18h00','Afternoon');

      left.appendChild(checkbox);
      left.appendChild(label);

      const pill = document.createElement('div');
      pill.id = idFor(day, slot);
      pill.className = 'seat-pill pill-available';
      pill.innerText = '…';

      row.appendChild(left);
      row.appendChild(pill);
      dayCard.appendChild(row);
    });

    daysGrid.appendChild(dayCard);
  });
}

// fetch registrations and compute seatCounts per day-slot
async function fetchSeats(){
  try{
    const res = await fetch(JSONBIN_URL, {
      method:'GET',
      headers: { 'X-Access-Key': ACCESS_KEY }
    });
    const data = await res.json();
    // data.record expected to be array of registration objects; each object has days:[], slots:[]
    const registrations = data.record || [];

    // initialize counts
    seatCounts = {};
    days.forEach(d => slots.forEach(s => seatCounts[`${d}|${s}`] = MAX_PER_SLOT));

    registrations.forEach(reg => {
      const regDays = Array.isArray(reg.days) ? reg.days : (reg.days ? [reg.days] : []);
      const regSlots = Array.isArray(reg.slots) ? reg.slots : (reg.slots ? [reg.slots] : []);
      regDays.forEach(d => {
        regSlots.forEach(s => {
          const key = `${d}|${s}`;
          if(seatCounts[key] !== undefined) seatCounts[key] = Math.max(0, seatCounts[key]-1);
        });
      });
    });

    // render badges and disable full slots
    renderSeatBadges();
  } catch(err){
    console.error('fetchSeats error', err);
    // If error, assume full MAX for display
    days.forEach(d => slots.forEach(s => seatCounts[`${d}|${s}`] = MAX_PER_SLOT));
    renderSeatBadges();
  }
}

function renderSeatBadges(){
  days.forEach(d => {
    slots.forEach(s => {
      const key = `${d}|${s}`;
      const el = document.getElementById(idFor(d,s));
      const cb = document.querySelector(`input.slot-checkbox[data-day="${d}"][data-slot="${s}"]`);
      const left = seatCounts[key] ?? 0;
      if(!el) return;
      // color logic
      if(left <= 0){
        el.className = 'seat-pill pill-full';
        el.innerText = 'Full';
        if(cb){ cb.disabled = true; cb.checked = false; cb.parentElement.style.opacity = 0.5; }
      } else if(left <= 5){
        el.className = 'seat-pill pill-low';
        el.innerText = `${left} left`;
        if(cb){ cb.disabled = false; cb.parentElement.style.opacity = 1; }
      } else {
        el.className = 'seat-pill pill-available';
        el.innerText = `${left} left`;
        if(cb){ cb.disabled = false; cb.parentElement.style.opacity = 1; }
      }
    });
  });
  updateTotalPrice();
}

// compute total price
function updateTotalPrice(){
  const checked = document.querySelectorAll('input.slot-checkbox:checked');
  const total = checked.length * PRICE_PER_SLOT;
  totalPriceEl.innerText = `R${total}`;
}

// debounce helper
function debounce(fn, delay){
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), delay); };
}

// when user toggles checkboxes, update price and (optionally) refresh seats live
const debouncedFetchSeats = debounce(fetchSeats, 350);
document.addEventListener('change', (e) => {
  if(e.target && e.target.classList && e.target.classList.contains('slot-checkbox')){
    updateTotalPrice();
    // refresh counts live so users see near-real-time availability
    debouncedFetchSeats();
  }
});

// submit handler
submitBtn.addEventListener('click', async (evt) => {
  evt.preventDefault();
  successMsgEl.style.display = 'none';

  const name = document.getElementById('name').value.trim();
  const surname = document.getElementById('surname').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const grade = document.getElementById('grade').value;

  if(!name || !surname || !phone){ alert('Enter name, surname and phone'); return; }

  // collect selected day-slot combos
  const checked = Array.from(document.querySelectorAll('input.slot-checkbox:checked'));
  if(checked.length === 0){ alert('Please select at least one Day + Slot'); return; }

  // Build arrays of unique days & slots per the earlier data structure (we will store arrays)
  const daysSelected = [...new Set(checked.map(c=>c.dataset.day))];
  const slotsSelected = [...new Set(checked.map(c=>c.dataset.slot))];

  // Double-check availability (fetch fresh seats)
  await fetchSeats();
  // check each checked combination
  const fullCombos = [];
  checked.forEach(cb=>{
    const key = `${cb.dataset.day}|${cb.dataset.slot}`;
    if((seatCounts[key] ?? 0) <= 0) fullCombos.push(`${cb.dataset.day} ${cb.dataset.slot}`);
  });
  if(fullCombos.length){
    alert('Sorry — these became full:\n' + fullCombos.join('\n') + '\nPlease adjust your selection.');
    return;
  }

  // prepare registration object; we'll store each registration as an object
  // Keep the same schema used earlier: { timestamp, name, surname, phone, grade, days:[], slots:[] }
  const regObj = {
    timestamp: (new Date()).toISOString(),
    name, surname, phone, grade,
    days: daysSelected,
    slots: slotsSelected
  };

  // fetch existing array
  try{
    const resGet = await fetch(JSONBIN_URL, { method: 'GET', headers: { 'X-Access-Key': ACCESS_KEY }});
    const json = await resGet.json();
    const registrations = Array.isArray(json.record) ? json.record : [];

    // push and PUT back (replace whole bin content with new array)
    registrations.push(regObj);

    const resPut = await fetch(JSONBIN_URL, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json', 'X-Access-Key': ACCESS_KEY },
      body: JSON.stringify(registrations)
    });

    if(!resPut.ok) throw new Error('Save failed');

    // success UI
    successMsgEl.style.display = 'block';
    successMsgEl.innerText = `Registered! Total: R${checked.length * PRICE_PER_SLOT}`;
    // reset form lightly
    document.getElementById('name').value=''; document.getElementById('surname').value=''; document.getElementById('phone').value='';
    document.getElementById('grade').value='Grade 10';
    document.querySelectorAll('input.slot-checkbox').forEach(cb=>cb.checked=false);
    updateTotalPrice();
    // refresh seats to show updated counts
    await fetchSeats();

  } catch(err){
    console.error(err);
    alert('There was a problem saving your registration. Try again.');
  }
});

// init
buildGrid();
fetchSeats();
updateTotalPrice();
</script>
</body>
</html>
